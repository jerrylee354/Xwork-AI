<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chatbot - Gemini UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #131314; color: #ededed; font-family: 'Segoe UI', Arial, sans-serif; }
    body, #root { height: 100vh; }
    #container { display: flex; height: 100vh; min-height: 0; }
    #sidebar {
      width: 280px;
      background: #232329;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100vh;
      min-width: 60px;
      transition: width 0.2s;
    }
    #sidebar-header {
      padding: 24px 24px 0 24px;
      font-weight: bold;
      font-size: 1.4rem;
      letter-spacing: 0.5px;
      word-break: break-word;
    }
    #sidebar-desc {
      font-size: 0.95rem;
      color: #b5b5be;
      padding: 8px 24px;
      min-height: 64px;
      word-break: break-word;
    }
    #sidebar-bottom {
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #19191d;
      font-size: 1rem;
      border-top: 1px solid #282830;
      min-width: 0;
      word-break: break-word;
    }
    #sidebar-bottom .status-dot {
      width: 12px; height: 12px; background: #19c37d; border-radius: 50%; display: inline-block;
    }
    #main {
      flex: 1;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      background: #131314;
      width: 100%;
    }
    #welcome {
      margin-bottom: 30px;
      text-align: center;
      margin-top: -70px;
      word-break: break-word;
    }
    #welcome h1 {
      font-size: 2.4rem;
      font-weight: bold;
      color: #fff;
      margin: 0 0 10px 0;
      word-break: break-word;
    }
    #welcome p {
      color: #b5b5be;
      font-size: 1.3rem;
      margin: 0;
      word-break: break-word;
    }
    #suggestions-bar {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      gap: 16px;
      margin-bottom: 8px;
      position: absolute;
      left: 0; right: 0;
      bottom: 78px;
      z-index: 2;
      transition: opacity .2s;
      overflow-x: auto;
      padding: 0 8px;
      scrollbar-width: thin;
      scrollbar-color: #3c3c3c #19191d;
    }
    .suggestion-btn {
      background: #19191d;
      color: #ededed;
      border: 1px solid #2a2a32;
      border-radius: 10px;
      padding: 12px 18px;
      font-size: 1.03rem;
      cursor: pointer;
      min-width: 140px;
      text-align: left;
      transition: border 0.15s, background 0.15s;
      white-space: nowrap;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.6s cubic-bezier(.23,1.18,.42,0.98) forwards;
      margin-bottom: 0;
      margin-right: 8px;
      margin-left: 0;
      margin-top: 0;
      display: inline-block;
    }
    .suggestion-btn:last-child {
      margin-right: 0;
    }
    .suggestion-btn:hover {
      border: 1.5px solid #5d5dff;
      background: #23232a;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    #chat-area {
      width: 100%;
      max-width: 700px;
      margin: 0 auto 90px auto;
      flex: 1 1 0%;
      min-height: 0;
      display: none;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      background: transparent;
      word-break: break-word;
    }
    .msg-row {
      display: flex;
      margin-bottom: 10px;
    }
    .msg-user { justify-content: flex-end; }
    .msg-ai { justify-content: flex-start; }
    .bubble {
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 1.08rem;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-line;
      background: #19191d;
      color: #ededed;
      border-bottom-left-radius: 6px;
      opacity: 1;
      transform: none;
      transition: none;
    }
    .bubble.user {
      background: #5d5dff;
      color: #fff;
      border-bottom-right-radius: 6px;
      border-bottom-left-radius: 16px;
    }
    .fade-in-anim {
      opacity: 0;
      transform: translate(-12px, -12px) scale(0.98);
      animation: fadeInFromCorner 0.9s cubic-bezier(.23,1.18,.42,0.98) forwards;
    }
    @keyframes fadeInFromCorner {
      from {
        opacity: 0;
        transform: translate(-12px, -12px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    .messageBox {
      width: 100%;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #1e1e1e;
      padding: 0 15px;
      border-radius: 10px;
      border: 1px solid rgb(63, 63, 63);
      box-sizing: border-box;
      gap: 8px;
    }
    .messageBox:focus-within {
      border: 1px solid #606060;
    }
    .fileUploadWrapper {
      width: fit-content;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, Helvetica, sans-serif;
      position: relative;
    }
    #file {
      display: none;
    }
    .fileUploadWrapper label {
      cursor: pointer;
      width: fit-content;
      height: fit-content;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .fileUploadWrapper label svg {
      height: 18px;
    }
    .fileUploadWrapper label svg path {
      transition: all 0.3s;
    }
    .fileUploadWrapper label svg circle {
      transition: all 0.3s;
    }
    .fileUploadWrapper label:hover svg path {
      stroke: #fff;
    }
    .fileUploadWrapper label:hover svg circle {
      stroke: #fff;
      fill: #3c3c3c;
    }
    .fileUploadWrapper label:hover .tooltip {
      display: block;
      opacity: 1;
    }
    .tooltip {
      position: absolute;
      top: -40px;
      display: none;
      opacity: 0;
      color: white;
      font-size: 10px;
      text-wrap: nowrap;
      background-color: #000;
      padding: 6px 10px;
      border: 1px solid #3c3c3c;
      border-radius: 5px;
      box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.596);
      transition: all 0.3s;
      left: 50%;
      transform: translateX(-50%);
      pointer-events:none;
    }
    .filename-label {
      color: #f5f5f5;
      font-size: 0.98em;
      margin: 0 8px;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #222;
      border-radius: 5px;
      padding: 2px 8px;
    }
    .file-preview {
      max-height: 32px;
      max-width: 48px;
      margin-right: 8px;
      border-radius: 4px;
      vertical-align: middle;
      background: #222;
      object-fit: contain;
    }
    #messageInput {
      width: 200px;
      flex: 1;
      height: 100%;
      background-color: transparent;
      outline: none;
      border: none;
      padding-left: 10px;
      color: #f5f5f5;
      font-size: 1.1rem;
      min-width: 0;
    }
    #messageInput:focus ~ #sendButton svg path,
    #messageInput:valid ~ #sendButton svg path {
      fill: #3c3c3c;
      stroke: white;
    }
    #sendButton {
      width: fit-content;
      height: 100%;
      background-color: transparent;
      outline: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    #sendButton svg {
      height: 18px;
      transition: all 0.3s;
    }
    #sendButton svg path {
      transition: all 0.3s;
    }
    #sendButton:hover svg path {
      fill: #3682f4;
      stroke: white;
    }
    #input-box {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      position: absolute;
      bottom: 0;
      left: 0; right: 0;
      padding: 0 0 24px 0;
      display: flex;
      align-items: center;
      background: transparent;
      z-index: 3;
      justify-content: center;
    }
    /* 滾輪細節 */
    #suggestions-bar::-webkit-scrollbar {
      height: 7px;
      background: #19191d;
    }
    #suggestions-bar::-webkit-scrollbar-thumb {
      background: #3c3c3c;
      border-radius: 6px;
    }
    /* 響應式 */
    @media (max-width: 1200px) {
      #sidebar {
        width: 160px;
      }
      #sidebar-header {
        font-size: 1.2rem;
      }
      #welcome h1 {
        font-size: 1.8rem;
      }
      #welcome p {
        font-size: 1.05rem;
      }
    }
    @media (max-width: 900px) {
      #sidebar { width: 60px; min-width: 0; }
      #sidebar-header, #sidebar-desc, #sidebar-bottom { display: none; }
      #main, #input-box, #chat-area, #suggestions-bar { max-width: 98vw; }
    }
    @media (max-width: 700px) {
      #main, #input-box, #chat-area, #suggestions-bar { max-width: 99vw; }
      #sidebar { display: none; }
      #container { flex-direction: column; }
      #suggestions-bar {
        max-width: 99vw;
        padding: 0 2vw;
        gap: 10px;
      }
      .suggestion-btn { min-width: 90px; padding: 9px 10px; font-size:0.98em;}
      .filename-label { max-width: 60px; font-size: 0.92em;}
      .file-preview { max-width: 32px; max-height: 24px;}
      #chat-area { margin-bottom: 76px;}
    }
    @media (max-width: 500px) {
      #chat-area, #input-box, #suggestions-bar { max-width: 100vw; }
      #suggestions-bar { gap: 6px; padding: 0 1vw; }
      .suggestion-btn { min-width: 70px; padding: 7px 6px; font-size:0.92em;}
    }
  </style>
</head>
<body>
<div id="root">
  <div id="container">
    <!-- Sidebar -->
    <div id="sidebar">
      <div>
        <div id="sidebar-header">Chatbot</div>
        <div id="sidebar-desc">Your conversations will appear here once you start chatting!</div>
      </div>
      <div id="sidebar-bottom">
        <span class="status-dot"></span>
        <span>Guest</span>
      </div>
    </div>
    <!-- Main -->
    <div id="main">
      <!-- 歡迎 -->
      <div id="welcome">
        <h1>Hello there!</h1>
        <p>How can I help you today?</p>
      </div>
      <!-- 預測回覆橫條 -->
      <div id="suggestions-bar"></div>
      <!-- 聊天區 -->
      <div id="chat-area"></div>
      <!-- 輸入區 -->
      <form id="input-box" autocomplete="off">
        <div class="messageBox">
          <div class="fileUploadWrapper">
            <input type="file" id="file" accept="image/*,.txt,.md,.csv,.json,.pdf" />
            <label for="file" title="Upload file">
              <svg viewBox="0 0 24 24" fill="none" stroke="#adadad" stroke-width="2"><circle cx="12" cy="12" r="9" stroke="#adadad"/><path d="M15 13l-3-3-3 3"/><path d="M12 10v6"/></svg>
              <div class="tooltip">Upload file/image</div>
            </label>
          </div>
          <img id="file-preview" class="file-preview" style="display:none;">
          <span class="filename-label" id="filename-label" style="display:none;"></span>
          <input id="messageInput" required placeholder="Send a message..." autocomplete="off" />
          <button id="sendButton" type="submit">
            <svg viewBox="0 0 18 18" fill="none"><path d="M2.5 15.5L15.5 9L2.5 2.5V7.5L11.5 9L2.5 10.5V15.5Z" fill="#adadad" stroke="#adadad" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
const apiKey = "AIzaSyAjewm6dDlfMTvY26H_qGNdo4GZ7YGogyE";
const chatArea = document.getElementById('chat-area');
const chatInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendButton');
const inputBox = document.getElementById('input-box');
const fileInput = document.getElementById('file');
const filenameLabel = document.getElementById('filename-label');
const filePreview = document.getElementById('file-preview');
const welcome = document.getElementById('welcome');
const suggestionsBar = document.getElementById('suggestions-bar');
let chatting = false;
let uploadedFile = null;
let uploadedContent = null;
let uploadedImageBase64 = null;
let uploadedImageMime = null;

// =======================
// Contextual Memory
// =======================
let conversationHistory = []; // {role: 'user'|'model', parts: [{text|inline_data}]}
const MAX_CONTEXT_MESSAGES = 8; // 包含最新提問與歷史上下文

// 動態生成英文預測回覆，每則10~15字，並有動畫
async function fetchSuggestions() {
  suggestionsBar.innerHTML = '<div style="color:#aaa;font-size:1.05em;padding:15px 0;">AI is generating suggestions...</div>';
  try {
    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + apiKey, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [
          { parts: [ { text: "Generate 4 diverse, creative, interesting, and useful English prompts for an AI assistant. Each should be a plausible chat question, strictly between 10 and 15 characters (including spaces), no numbering, no explanation, one per line." } ] }
        ]
      })
    });
    const data = await response.json();
    let suggestionList = [];
    if(data.candidates && data.candidates[0]) {
      const raw = data.candidates[0].content.parts[0].text;
      suggestionList = raw.split("\n").map(s=>s.trim()).filter(Boolean);
      // 過濾長度
      suggestionList = suggestionList.filter(sug => sug.length >= 10 && sug.length <= 15);
      if (suggestionList.length > 4) suggestionList = suggestionList.slice(0,4);
      if (suggestionList.length === 1 && (suggestionList[0].includes("|") || suggestionList[0].includes(";"))) {
        suggestionList = suggestionList[0].split(/[|;]+/).map(s=>s.trim()).filter(Boolean);
      }
    }
    while (suggestionList.length < 4) {
      suggestionList.push("What's your hobby?");
    }
    // 動態生成四顆建議按鈕，有動畫
    suggestionsBar.innerHTML = "";
    suggestionList.forEach((sug, idx) => {
      const btn = document.createElement('button');
      btn.className = 'suggestion-btn';
      btn.innerText = sug;
      btn.style.animationDelay = (0.07 * idx) + 's'; // 漸層動畫
      btn.addEventListener('click', () => {
        chatInput.value = sug;
        sendBtn.click();
      });
      suggestionsBar.appendChild(btn);
    });
  } catch(e) {
    suggestionsBar.innerHTML = '<div style="color:#aaa;">AI suggestions failed. Please refresh.</div>';
  }
}

// 頁面剛載入時（還沒問任何問題）才顯示預測回覆
function showSuggestionsBar(show) {
  suggestionsBar.style.display = show ? 'flex' : 'none';
  if(show) fetchSuggestions();
}

// 只要輸入框有內容或曾經問過問題就隱藏預測回覆
chatInput.addEventListener('input', () => {
  if (chatInput.value.trim().length > 0) {
    showSuggestionsBar(false);
  } else if (!chatting) {
    showSuggestionsBar(true);
  }
});

// 顯示訊息泡泡
function appendMsg(text, sender, isTyping = false, anim = false) {
  const row = document.createElement('div');
  row.className = 'msg-row msg-' + sender;
  const bubble = document.createElement('div');
  bubble.className = `bubble ${sender}`;
  if (isTyping) {
    bubble.innerHTML = '<span style="color:#b5b5be">AI is typing...</span>';
    row.appendChild(bubble);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
    return bubble;
  } else {
    bubble.innerHTML = text.replace(/\n/g, '<br>');
    if (anim) bubble.classList.add('fade-in-anim');
    row.appendChild(bubble);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
    return bubble;
  }
}

// 淡入動畫顯示AI訊息
function fadeInAIMessage(bubble, text) {
  bubble.classList.add('fade-in-anim');
  bubble.innerHTML = text.replace(/\n/g, '<br>');
}

// 檔案處理
fileInput.addEventListener('change', () => {
  uploadedFile = null;
  uploadedContent = null;
  uploadedImageBase64 = null;
  uploadedImageMime = null;
  filenameLabel.textContent = '';
  filenameLabel.style.display = 'none';
  filePreview.style.display = 'none';
  filePreview.src = '';
  if(fileInput.files.length > 0){
    uploadedFile = fileInput.files[0];
    filenameLabel.textContent = uploadedFile.name;
    filenameLabel.style.display = 'inline';
    const mimeType = uploadedFile.type;
    if(mimeType.startsWith('image/')){
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result.split(',')[1];
        uploadedImageBase64 = base64;
        uploadedImageMime = mimeType;
        filePreview.src = e.target.result;
        filePreview.style.display = 'inline-block';
      };
      reader.readAsDataURL(uploadedFile);
    }
    else if(mimeType === "text/plain" || mimeType === "text/markdown" || mimeType === "application/json" || mimeType === "text/csv"){
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedContent = e.target.result;
      };
      reader.readAsText(uploadedFile);
    }
    else{
      uploadedContent = "[Unsupported file type]";
    }
  }
});

// 處理送出訊息
inputBox.addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = chatInput.value.trim();
  if (!msg && !uploadedContent && !uploadedImageBase64) return;
  chatInput.value = '';
  // 開始聊天後永遠隱藏預測回覆
  showSuggestionsBar(false);
  if (!chatting) {
    welcome.style.display = 'none';
    chatArea.style.display = 'flex';
    chatting = true;
  }
  // 顯示使用者訊息
  let userMsg = msg;
  let hasImage = uploadedImageBase64 != null;
  if(uploadedFile){
    if(hasImage){
      userMsg += `\n[Uploaded image: ${uploadedFile.name}]`;
      appendMsg(userMsg + `<br><img src="data:${uploadedImageMime};base64,${uploadedImageBase64}" style="max-width:128px;max-height:64px;border-radius:7px;margin-top:8px;">`, 'user', false, false);
    }else if(uploadedContent){
      userMsg += `\n[Uploaded file: ${uploadedFile.name}]\n` + uploadedContent;
      appendMsg(userMsg, 'user', false, false);
    }else{
      appendMsg(userMsg, 'user', false, false);
    }
  }else{
    appendMsg(userMsg, 'user', false, false);
  }

  // === 上下文記憶：加入到對話歷史 ===
  let userParts = [];
  if(msg) userParts.push({ text: msg });
  if(hasImage){
    userParts.push({
      inline_data: {
        mime_type: uploadedImageMime,
        data: uploadedImageBase64
      }
    });
  } else if(uploadedContent){
    userParts.push({ text: `\n[Uploaded file: ${uploadedFile.name}]\n${uploadedContent}` });
  }
  conversationHistory.push({ role: "user", parts: userParts });

  sendBtn.disabled = true;
  const aiBubble = appendMsg('', 'ai', true, false);

  // === 準備上下文內容，帶入最多 MAX_CONTEXT_MESSAGES 則對話（雙方一組）
  let contextToSend = [];
  if (conversationHistory.length > MAX_CONTEXT_MESSAGES) {
    contextToSend = conversationHistory.slice(-MAX_CONTEXT_MESSAGES);
  } else {
    contextToSend = [...conversationHistory];
  }

  try {
    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + apiKey, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: contextToSend })
    });
    const data = await response.json();
    chatArea.removeChild(aiBubble.parentNode); // 移除思考中
    const newBubble = appendMsg('', 'ai', false, true);
    if (data.candidates && data.candidates[0]) {
      const aiMsg = data.candidates[0].content.parts[0].text;
      fadeInAIMessage(newBubble, aiMsg);

      // === 上下文記憶：AI回覆也加入對話歷史 ===
      conversationHistory.push({
        role: "model",
        parts: data.candidates[0].content.parts
      });
    } else {
      fadeInAIMessage(newBubble, 'Sorry, AI returned no answer.');
      conversationHistory.push({
        role: "model",
        parts: [{ text: "Sorry, AI returned no answer." }]
      });
    }
  } catch (err) {
    chatArea.removeChild(aiBubble.parentNode);
    const newBubble = appendMsg('', 'ai', false, true);
    fadeInAIMessage(newBubble, 'Network error. Please try again.');
    conversationHistory.push({
      role: "model",
      parts: [{ text: "Network error. Please try again." }]
    });
  }
  sendBtn.disabled = false;
  // 重設檔案
  uploadedFile = null;
  uploadedContent = null;
  uploadedImageBase64 = null;
  uploadedImageMime = null;
  fileInput.value = '';
  filenameLabel.textContent = '';
  filenameLabel.style.display = 'none';
  filePreview.style.display = 'none';
  filePreview.src = '';
});

// 初始僅在未提問時顯示建議（會自動請AI產生建議問題）
showSuggestionsBar(true);
</script>
</body>
</html>
