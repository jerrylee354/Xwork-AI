<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chatbot - Gemini UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #131314; color: #ededed; font-family: 'Segoe UI', Arial, sans-serif; }
    body, #root { height: 100vh; }
    #container { display: flex; height: 100vh; min-height: 0; }
    #sidebar {
      width: 280px;
      background: #232329;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      min-width: 60px;
      transition: width 0.25s cubic-bezier(.7,0,.3,1), min-width 0.25s cubic-bezier(.7,0,.3,1), opacity 0.18s;
      position: relative;
      z-index: 10;
      overflow: hidden;
      opacity: 1;
    }
    #sidebar.collapsed {
      width: 0 !important;
      min-width: 0 !important;
      opacity: 0;
      pointer-events: none;
    }
    #sidebar-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      flex: 1 1 0%;
      min-height: 0;
      min-width: 0;
    }
    #sidebar-header-row {
      display: flex;
      align-items: center;
      padding: 24px 24px 0 24px;
      min-height: 44px;
      background: #232329;
      position: relative;
      flex-shrink: 0;
    }
    #sidebar-header {
      font-weight: bold;
      font-size: 1.4rem;
      letter-spacing: 0.5px;
      word-break: break-word;
      margin-right: 14px;
    }
    .sidebar-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .sidebar-header-btn,
    #sidebar-collapse-btn {
      cursor: pointer;
      background: none;
      border: none;
      outline: none;
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 8px;
      transition: background 0.15s, border 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 0;
      margin-right: 0;
      font-size: 0;
    }
    .sidebar-header-btn:hover,
    #sidebar-collapse-btn:hover {
      background: #19191d;
      border: 1px solid #35353d;
    }
    .sidebar-header-btn svg,
    #sidebar-collapse-btn svg {
      display: block;
      width: 22px;
      height: 22px;
      color: #e0e0e0;
      stroke: #e0e0e0;
    }
    #sidebar-collapse-btn {
      margin-left: 0;
      margin-right: 0;
      position: static;
      top: auto;
      right: auto;
      z-index: 11;
    }
    #sidebar-main-block {
      flex: 1 1 auto;
      min-height: 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chat-list {
      flex: 1 1 auto;
      min-height: 0;
      max-height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 10px 8px 0 8px;
    }
    .chat-list-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-radius: 7px;
      background: none;
      color: #ededed;
      font-size: 1.04em;
      border: none;
      cursor: pointer;
      margin-bottom: 0;
      margin-right: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background .14s, color .14s;
      opacity: 0.92;
      max-width: 100%;
    }
    .chat-list-item.active,
    .chat-list-item:hover {
      background: #29293a;
      color: #fff;
      opacity: 1;
    }
    .chat-list-item-title {
      flex: 1 1 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 90%;
      min-width: 0;
      font-size: 1em;
    }
    #sidebar-restore-btn {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 36px;
      height: 36px;
      background: #232329;
      border: 1px solid #35353d;
      border-radius: 8px;
      padding: 0;
      cursor: pointer;
      z-index: 30;
      display: none;
      align-items: center;
      box-shadow: 1px 2px 8px rgba(0,0,0,0.14);
      transition: left 0.25s cubic-bezier(.7,0,.3,1), opacity 0.18s;
      justify-content: center;
    }
    #sidebar-restore-btn svg {
      width: 22px;
      height: 22px;
      stroke: #ededed;
      color: #ededed;
      background: none;
    }
    #sidebar.collapsed ~ #sidebar-restore-btn {
      display: flex;
      opacity: 1;
    }
    #sidebar-desc {
      font-size: 0.95rem;
      color: #b5b5be;
      padding: 8px 24px;
      min-height: 64px;
      word-break: break-word;
      display: block;
      transition: opacity 0.18s;
      flex-shrink: 0;
    }
    #sidebar-desc.hide {
      display: none !important;
    }
    #sidebar-bottom {
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #19191d;
      font-size: 1rem;
      border-top: 1px solid #282830;
      min-width: 0;
      word-break: break-word;
      flex-shrink: 0;
    }
    #sidebar-bottom .status-dot {
      width: 12px; height: 12px; background: #19c37d; border-radius: 50%; display: inline-block;
    }
    .loader {
      position: relative;
      width: 54px;
      height: 54px;
      border-radius: 10px;
      margin: 18px auto 13px auto;
    }
    .loader div {
      width: 8%;
      height: 24%;
      background: rgb(128, 128, 128);
      position: absolute;
      left: 50%;
      top: 30%;
      opacity: 0;
      border-radius: 50px;
      box-shadow: 0 0 3px rgba(0,0,0,0.2);
      animation: fade458 1s linear infinite;
    }
    @keyframes fade458 {
      from {
        opacity: 1;
      }
      to {
        opacity: 0.25;
      }
    }
    .loader .bar1 { transform: rotate(0deg) translate(0, -130%); animation-delay: 0s;}
    .loader .bar2 { transform: rotate(30deg) translate(0, -130%); animation-delay: -1.1s;}
    .loader .bar3 { transform: rotate(60deg) translate(0, -130%); animation-delay: -1s;}
    .loader .bar4 { transform: rotate(90deg) translate(0, -130%); animation-delay: -0.9s;}
    .loader .bar5 { transform: rotate(120deg) translate(0, -130%); animation-delay: -0.8s;}
    .loader .bar6 { transform: rotate(150deg) translate(0, -130%); animation-delay: -0.7s;}
    .loader .bar7 { transform: rotate(180deg) translate(0, -130%); animation-delay: -0.6s;}
    .loader .bar8 { transform: rotate(210deg) translate(0, -130%); animation-delay: -0.5s;}
    .loader .bar9 { transform: rotate(240deg) translate(0, -130%); animation-delay: -0.4s;}
    .loader .bar10 { transform: rotate(270deg) translate(0, -130%); animation-delay: -0.3s;}
    .loader .bar11 { transform: rotate(300deg) translate(0, -130%); animation-delay: -0.2s;}
    .loader .bar12 { transform: rotate(330deg) translate(0, -130%); animation-delay: -0.1s;}
    #main {
      flex: 1;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      background: #131314;
      width: 100%;
    }
    #welcome {
      margin-bottom: 30px;
      text-align: center;
      margin-top: -70px;
      word-break: break-word;
    }
    #welcome h1 {
      font-size: 2.4rem;
      font-weight: bold;
      color: #fff;
      margin: 0 0 10px 0;
      word-break: break-word;
    }
    #welcome p {
      color: #b5b5be;
      font-size: 1.3rem;
      margin: 0;
      word-break: break-word;
    }
    #suggestions-bar {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      gap: 16px;
      margin-bottom: 8px;
      position: absolute;
      left: 0; right: 0;
      bottom: 78px;
      z-index: 2;
      transition: opacity .2s;
      overflow-x: auto;
      padding: 0 8px;
      scrollbar-width: thin;
      scrollbar-color: #3c3c3c #19191d;
    }
    .suggestion-btn {
      background: #19191d;
      color: #ededed;
      border: 1px solid #2a2a32;
      border-radius: 10px;
      padding: 12px 10px;
      font-size: 1.03rem;
      cursor: pointer;
      min-width: 140px;
      max-width: 225px;
      text-align: left;
      transition: border 0.15s, background 0.15s;
      white-space: normal;
      line-height: 1.25em;
      display: inline-block;
      height: auto;
      overflow: hidden;
      text-overflow: ellipsis;
      word-break: break-word;
      box-sizing: border-box;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.6s cubic-bezier(.23,1.18,.42,0.98) forwards;
      user-select: none;
    }
    .suggestion-btn:last-child {
      margin-right: 0;
    }
    .suggestion-btn:hover, .suggestion-btn:focus {
      border: 1.5px solid #5d5dff;
      background: #23232a;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    #chat-area {
      width: 100%;
      max-width: 700px;
      margin: 0 auto 90px auto;
      flex: 1 1 0%;
      min-height: 0;
      display: none;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      background: transparent;
      word-break: break-word;
    }
    .msg-row {
      display: flex;
      margin-bottom: 10px;
    }
    .msg-user { justify-content: flex-end; }
    .msg-ai { justify-content: flex-start; }
    .bubble {
      max-width: 70%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 1.08rem;
      line-height: 1.6;
      word-break: break-word;
      white-space: pre-line;
      background: #19191d;
      color: #ededed;
      border-bottom-left-radius: 6px;
      opacity: 1;
      transform: none;
      transition: none;
    }
    .bubble.user {
      background: #5d5dff;
      color: #fff;
      border-bottom-right-radius: 6px;
      border-bottom-left-radius: 16px;
    }
    .fade-in-anim {
      opacity: 0;
      transform: translate(-12px, -12px) scale(0.98);
      animation: fadeInFromCorner 0.9s cubic-bezier(.23,1.18,.42,0.98) forwards;
    }
    @keyframes fadeInFromCorner {
      from {
        opacity: 0;
        transform: translate(-12px, -12px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    .messageBox {
      width: 100%;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #1e1e1e;
      padding: 0 15px;
      border-radius: 10px;
      border: 1px solid rgb(63, 63, 63);
      box-sizing: border-box;
      gap: 8px;
    }
    .messageBox:focus-within {
      border: 1px solid #606060;
    }
    .fileUploadWrapper {
      width: fit-content;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, Helvetica, sans-serif;
      position: relative;
    }
    #file {
      display: none;
    }
    .fileUploadWrapper label {
      cursor: pointer;
      width: fit-content;
      height: fit-content;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .fileUploadWrapper label svg {
      height: 18px;
    }
    .fileUploadWrapper label svg path {
      transition: all 0.3s;
    }
    .fileUploadWrapper label svg circle {
      transition: all 0.3s;
    }
    .fileUploadWrapper label:hover svg path {
      stroke: #fff;
    }
    .fileUploadWrapper label:hover svg circle {
      stroke: #fff;
      fill: #3c3c3c;
    }
    .fileUploadWrapper label:hover .tooltip {
      display: block;
      opacity: 1;
    }
    .tooltip {
      position: absolute;
      top: -40px;
      display: none;
      opacity: 0;
      color: white;
      font-size: 10px;
      text-wrap: nowrap;
      background-color: #000;
      padding: 6px 10px;
      border: 1px solid #3c3c3c;
      border-radius: 5px;
      box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.596);
      transition: all 0.3s;
      left: 50%;
      transform: translateX(-50%);
      pointer-events:none;
    }
    .filename-label {
      color: #f5f5f5;
      font-size: 0.98em;
      margin: 0 8px;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #222;
      border-radius: 5px;
      padding: 2px 8px;
    }
    .file-preview {
      max-height: 32px;
      max-width: 48px;
      margin-right: 8px;
      border-radius: 4px;
      vertical-align: middle;
      background: #222;
      object-fit: contain;
    }
    #messageInput {
      width: 200px;
      flex: 1;
      height: 100%;
      background-color: transparent;
      outline: none;
      border: none;
      padding-left: 10px;
      color: #f5f5f5;
      font-size: 1.1rem;
      min-width: 0;
    }
    #messageInput:focus ~ #sendButton svg path,
    #messageInput:valid ~ #sendButton svg path {
      fill: #3c3c3c;
      stroke: white;
    }
    #sendButton {
      width: fit-content;
      height: 100%;
      background-color: transparent;
      outline: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    #sendButton svg {
      height: 18px;
      transition: all 0.3s;
    }
    #sendButton svg path {
      transition: all 0.3s;
    }
    #sendButton:hover svg path {
      fill: #3682f4;
      stroke: white;
    }
    #input-box {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      position: absolute;
      bottom: 0;
      left: 0; right: 0;
      padding: 0 0 24px 0;
      display: flex;
      align-items: center;
      background: transparent;
      z-index: 3;
      justify-content: center;
    }
  </style>
</head>
<body>
<div id="root">
  <div id="container">
    <!-- Sidebar -->
    <div id="sidebar">
      <div id="sidebar-content">
        <div id="sidebar-header-row">
          <span id="sidebar-header">Chatbot</span>
          <span class="sidebar-header-actions">
            <button class="sidebar-header-btn" id="sidebar-add-btn" title="Add New Chat">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-linecap="round"/>
                <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-linecap="round"/>
              </svg>
            </button>
            <button id="sidebar-collapse-btn" title="Collapse Sidebar">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor"/>
                <rect x="8" y="8" width="8" height="8" rx="1.5" stroke="currentColor" fill="none"/>
              </svg>
            </button>
          </span>
        </div>
        <div id="sidebar-main-block">
          <div id="chat-list"></div>
          <div id="sidebar-desc">Your conversations will appear here once you start chatting!</div>
        </div>
      </div>
      <div id="sidebar-bottom">
        <span class="status-dot"></span>
        <span>Guest</span>
      </div>
    </div>
    <button id="sidebar-restore-btn" title="Show Sidebar" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor"/>
        <rect x="8" y="8" width="8" height="8" rx="1.5" stroke="currentColor" fill="none"/>
      </svg>
    </button>
    <div id="main">
      <div id="welcome">
        <h1>Hello there!</h1>
        <p>How can I help you today?</p>
      </div>
      <div id="suggestions-bar"></div>
      <div id="chat-area"></div>
      <form id="input-box" autocomplete="off">
        <div class="messageBox">
          <div class="fileUploadWrapper">
            <input type="file" id="file" accept="image/*,.txt,.md,.csv,.json,.pdf" />
            <label for="file" title="Upload file">
              <svg viewBox="0 0 24 24" fill="none" stroke="#adadad" stroke-width="2"><circle cx="12" cy="12" r="9" stroke="#adadad"/><path d="M15 13l-3-3-3 3"/><path d="M12 10v6"/></svg>
              <div class="tooltip">Upload file/image</div>
            </label>
          </div>
          <img id="file-preview" class="file-preview" style="display:none;">
          <span class="filename-label" id="filename-label" style="display:none;"></span>
          <input id="messageInput" required placeholder="Send a message..." autocomplete="off" />
          <button id="sendButton" type="submit">
            <svg viewBox="0 0 18 18" fill="none"><path d="M2.5 15.5L15.5 9L2.5 2.5V7.5L11.5 9L2.5 10.5V15.5Z" fill="#adadad" stroke="#adadad" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
const CHAT_KEY = "gemini-multi-chats-v1";
let chats = [];
let currentChatId = null;
let conversationHistory = [];
const MAX_CONTEXT_MESSAGES = 8;
const apiKey = "AIzaSyAjewm6dDlfMTvY26H_qGNdo4GZ7YGogyE";
const chatArea = document.getElementById('chat-area');
const chatInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendButton');
const inputBox = document.getElementById('input-box');
const fileInput = document.getElementById('file');
const filenameLabel = document.getElementById('filename-label');
const filePreview = document.getElementById('file-preview');
const welcome = document.getElementById('welcome');
const suggestionsBar = document.getElementById('suggestions-bar');
const sidebar = document.getElementById('sidebar');
const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
const sidebarRestoreBtn = document.getElementById('sidebar-restore-btn');
const sidebarAddBtn = document.getElementById('sidebar-add-btn');
const chatList = document.getElementById('chat-list');
const sidebarDesc = document.getElementById('sidebar-desc');
let chatting = false;
let uploadedFile = null;
let uploadedContent = null;
let uploadedImageBase64 = null;
let uploadedImageMime = null;

// -------- 聊天記錄存取 ---------
function saveChatsToStorage() {
  localStorage.setItem(CHAT_KEY, JSON.stringify(chats));
}
function loadChatsFromStorage() {
  showChatListLoader(true);
  setTimeout(() => {
    try {
      chats = JSON.parse(localStorage.getItem(CHAT_KEY)) || [];
      if (chats.length === 0) {
        chats = [createNewChatObj()];
      }
      if (!currentChatId || !chats.find(c => c.id === currentChatId)) {
        currentChatId = chats[0].id;
      }
      conversationHistory = chats.find(c => c.id === currentChatId).history;
    } catch {
      chats = [createNewChatObj()];
      currentChatId = chats[0].id;
      conversationHistory = chats[0].history;
    }
    showChatListLoader(false);
    renderChatList();
    renderChatHistory();
  }, 700);
}
function createNewChatObj() {
  return {
    id: 'chat_' + Date.now() + '_' + Math.floor(Math.random()*100000),
    history: [],
    title: 'New chat',
    aiTitleDone: false
  };
}
function updateChatTitle(chat, force) {
  if (chat.aiTitleDone) return;
  let firstUserMsg = null;
  for (let i = 0; i < chat.history.length; ++i) {
    if (chat.history[i].role === "user") {
      let text = "";
      chat.history[i].parts.forEach(p => { if (p.text) text += p.text; });
      if (text.trim()) {
        firstUserMsg = text.trim();
        break;
      }
    }
  }
  if (firstUserMsg && !chat.aiTitleDone) {
    genAITitle(firstUserMsg, chat.id);
    chat.title = firstUserMsg.slice(0, 20);
    return;
  }
  if (force || !chat.title) chat.title = 'New chat';
}
function renderChatList() {
  showChatListLoader(false);
  if (chats.length === 0 || (chats.length === 1 && chats[0].history.length === 0)) {
    sidebarDesc.classList.remove("hide");
  } else {
    sidebarDesc.classList.add("hide");
  }
  chatList.innerHTML = "";
  chats.forEach(chat => {
    const btn = document.createElement("button");
    btn.className = "chat-list-item" + (chat.id === currentChatId ? " active" : "");
    btn.innerHTML = `<span class="chat-list-item-title">${chat.title || "New chat"}</span>`;
    btn.onclick = () => {
      if (currentChatId !== chat.id) {
        switchChat(chat.id);
      }
    };
    chatList.appendChild(btn);
  });
}
function switchChat(chatId) {
  currentChatId = chatId;
  const chat = chats.find(c => c.id === chatId);
  if (!chat) return;
  conversationHistory = chat.history;
  renderChatList();
  renderChatHistory();
}
function addNewChat() {
  const chat = createNewChatObj();
  chats.unshift(chat);
  currentChatId = chat.id;
  conversationHistory = chat.history;
  renderChatList();
  renderChatHistory();
  setTimeout(() => {
    saveChatsToStorage();
  }, 0);
}
function renderChatHistory() {
  chatArea.innerHTML = "";
  let anyMsg = false;
  conversationHistory.forEach(msg => {
    if (msg.role === "user") {
      let text = msg.parts.map(p => p.text || "").join("");
      if (text.trim()) {
        appendMsg(text, "user");
        anyMsg = true;
      }
    } else if (msg.role === "model") {
      let text = msg.parts.map(p => p.text || "").join("");
      if (text.trim()) {
        appendMsg(text, "ai");
        anyMsg = true;
      }
    }
  });
  if (anyMsg) {
    welcome.style.display = "none";
    chatArea.style.display = "flex";
    chatting = true;
  } else {
    welcome.style.display = "";
    chatArea.style.display = "none";
    chatting = false;
  }
  if (chats.length === 0 || (chats.length === 1 && chats[0].history.length === 0)) {
    sidebarDesc.classList.remove("hide");
  } else {
    sidebarDesc.classList.add("hide");
  }
}
function showChatListLoader(show) {
  if (show) {
    chatList.innerHTML = `<div class="loader" id="chat-list-loader">
      <div class="bar1"></div><div class="bar2"></div><div class="bar3"></div><div class="bar4"></div>
      <div class="bar5"></div><div class="bar6"></div><div class="bar7"></div><div class="bar8"></div>
      <div class="bar9"></div><div class="bar10"></div><div class="bar11"></div><div class="bar12"></div>
    </div>`;
  } else {
    const loader = document.getElementById('chat-list-loader');
    if(loader) loader.remove();
  }
}
async function genAITitle(firstMsg, chatId) {
  const prompt = `請針對以下使用者的第一句提問，為這個對話擬一個最多10字的有意義聊天室標題，只回標題本身，不要任何標點或說明：
${firstMsg}`;
  try {
    const res = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-pro:generateContent?key=" + apiKey, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [
          { parts: [ { text: prompt } ] }
        ]
      })
    });
    const data = await res.json();
    let title = "";
    if(data.candidates && data.candidates[0] && data.candidates[0].content.parts[0].text) {
      title = data.candidates[0].content.parts[0].text.trim();
      title = title.replace(/^[\s\-\.：:【\[]+/,"").replace(/[\-\.\]】：:]+$/,"").replace(/\s+/g, "");
      if(title.length > 10) title = title.slice(0,10);
    }
    const chat = chats.find(c => c.id === chatId);
    if(chat) {
      chat.title = title || chat.title || firstMsg.slice(0, 10);
      chat.aiTitleDone = true;
      saveChatsToStorage();
      renderChatList();
    }
  } catch(e) { }
}
loadChatsFromStorage();

sidebarCollapseBtn.addEventListener('click', () => {
  sidebar.classList.add("collapsed");
  sidebarRestoreBtn.style.display = "flex";
  sidebarRestoreBtn.style.left = "24px";
});
sidebarRestoreBtn.addEventListener('click', () => {
  sidebar.classList.remove("collapsed");
  sidebarRestoreBtn.style.display = "none";
});
sidebarAddBtn.onclick = addNewChat;

async function fetchSuggestions() {
  suggestionsBar.innerHTML = '<div style="color:#aaa;font-size:1.05em;padding:15px 0;">AI is generating suggestions...</div>';
  try {
    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + apiKey, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [
          { parts: [ { text:
`Generate 8 diverse, creative, and useful English prompt questions for chatting with an AI assistant. Each should be 10-15 characters (including spaces), no numbering, no explanations, one per line, and all must be different from each other. Reply ONLY the prompts.` } ] }
        ]
      })
    });
    const data = await response.json();
    let suggestionList = [];
    if(data.candidates && data.candidates[0]) {
      const raw = data.candidates[0].content.parts[0].text;
      suggestionList = raw.split("\n").map(s=>s.trim()).filter(Boolean);
      suggestionList = suggestionList.filter((sug,idx,arr) =>
        sug.length >= 10 && sug.length <= 15 &&
        arr.indexOf(sug) === idx
      );
      const seen = {};
      suggestionList = suggestionList.filter(sug => {
        if (seen[sug.toLowerCase()]) return false;
        seen[sug.toLowerCase()] = true;
        return true;
      });
      if (suggestionList.length > 4) suggestionList = suggestionList.slice(0,4);
      if (suggestionList.length === 1 && (suggestionList[0].includes("|") || suggestionList[0].includes(";"))) {
        suggestionList = suggestionList[0].split(/[|;]+/).map(s=>s.trim()).filter(Boolean);
      }
    }
    while (suggestionList.length < 4) {
      const defaults = [
        "What's your hobby?", "Tell me a joke!", "Best book to read?", "Describe your day."
      ];
      for(const d of defaults){
        if(suggestionList.indexOf(d) === -1 && suggestionList.length<4) suggestionList.push(d);
      }
    }
    suggestionsBar.innerHTML = "";
    suggestionList.forEach((sug, idx) => {
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = 'suggestion-btn';
      btn.innerText = sug;
      btn.style.animationDelay = (0.07 * idx) + 's';
      btn.tabIndex = 0;
      btn.onclick = function(e) {
        e.preventDefault();
        chatInput.value = sug;
        // 觸發表單送出
        inputBox.dispatchEvent(new Event('submit', {bubbles:true, cancelable:true}));
        showSuggestionsBar(false);
      };
      btn.onkeydown = function(e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          btn.click();
        }
      };
      suggestionsBar.appendChild(btn);
    });
  } catch(e) {
    suggestionsBar.innerHTML = '<div style="color:#aaa;">AI suggestions failed. Please refresh.</div>';
  }
}
function showSuggestionsBar(show) {
  suggestionsBar.style.display = show ? 'flex' : 'none';
  if(show) fetchSuggestions();
}
chatInput.addEventListener('input', () => {
  if (chatInput.value.trim().length > 0) {
    showSuggestionsBar(false);
  } else if (!chatting) {
    showSuggestionsBar(true);
  }
});

function appendMsg(text, sender, isTyping = false, anim = false) {
  const row = document.createElement('div');
  row.className = 'msg-row msg-' + sender;
  const bubble = document.createElement('div');
  bubble.className = `bubble ${sender}`;
  if (isTyping) {
    bubble.innerHTML = '<span style="color:#b5b5be">AI is typing...</span>';
    row.appendChild(bubble);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
    return bubble;
  } else {
    bubble.innerHTML = text.replace(/\n/g, '<br>');
    if (anim) bubble.classList.add('fade-in-anim');
    row.appendChild(bubble);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
    return bubble;
  }
}
function fadeInAIMessage(bubble, text) {
  bubble.classList.add('fade-in-anim');
  bubble.innerHTML = text.replace(/\n/g, '<br>');
}

fileInput.addEventListener('change', () => {
  uploadedFile = null;
  uploadedContent = null;
  uploadedImageBase64 = null;
  uploadedImageMime = null;
  filenameLabel.textContent = '';
  filenameLabel.style.display = 'none';
  filePreview.style.display = 'none';
  filePreview.src = '';
  if(fileInput.files.length > 0){
    uploadedFile = fileInput.files[0];
    filenameLabel.textContent = uploadedFile.name;
    filenameLabel.style.display = 'inline';
    const mimeType = uploadedFile.type;
    if(mimeType.startsWith('image/')){
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedImageBase64 = e.target.result.split(',')[1];
        uploadedImageMime = mimeType;
        filePreview.src = e.target.result;
        filePreview.style.display = 'inline-block';
      };
      reader.readAsDataURL(uploadedFile);
    }
    else if(mimeType === "text/plain" || mimeType === "text/markdown" || mimeType === "application/json" || mimeType === "text/csv"){
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedContent = e.target.result;
      };
      reader.readAsText(uploadedFile);
    }
    else{
      uploadedContent = "[Unsupported file type]";
    }
  }
});

async function genImage(prompt) {
  const endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=" + apiKey;
  const payload = {
    contents: [
      { role: "user", parts: [ { text: `Please generate an image for this prompt, and ONLY return the image (base64 PNG, do not answer text): ${prompt}` } ] }
    ],
    generationConfig: {
      "response_mime_type": "image/png"
    }
  };
  const bubble = appendMsg('AI is drawing...', 'ai', true, false);
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    chatArea.removeChild(bubble.parentNode);
    let imgData = "";
    if(data.candidates && data.candidates[0] && data.candidates[0].content.parts[0].inline_data) {
      imgData = data.candidates[0].content.parts[0].inline_data.data;
    } else if (data.candidates && data.candidates[0] && data.candidates[0].content.parts[0].text) {
      imgData = data.candidates[0].content.parts[0].text;
    }
    if(imgData) {
      appendMsg(`<img src="data:image/png;base64,${imgData}" style="max-width:100%;max-height:320px;border-radius:12px;box-shadow:0 3px 16px #0004;margin:6px 0;">`, 'ai', false, true);
    } else {
      appendMsg('Sorry, failed to generate image.', 'ai', false, true);
    }
  } catch (e) {
    chatArea.removeChild(bubble.parentNode);
    appendMsg('Network error or image API error.', 'ai', false, true);
  }
}

inputBox.addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = chatInput.value.trim();
  if (!msg && !uploadedContent && !uploadedImageBase64) return;
  chatInput.value = '';
  showSuggestionsBar(false);
  if (!chatting) {
    welcome.style.display = 'none';
    chatArea.style.display = 'flex';
    chatting = true;
  }
  let userMsg = msg;
  let hasImage = uploadedImageBase64 != null;
  if(uploadedFile){
    if(hasImage){
      userMsg += `\n[Uploaded image: ${uploadedFile.name}]`;
      appendMsg(userMsg + `<br><img src="data:${uploadedImageMime};base64,${uploadedImageBase64}" style="max-width:128px;max-height:64px;border-radius:7px;margin-top:8px;">`, 'user', false, false);
    }else if(uploadedContent){
      userMsg += `\n[Uploaded file: ${uploadedFile.name}]\n` + uploadedContent;
      appendMsg(userMsg, 'user', false, false);
    }else{
      appendMsg(userMsg, 'user', false, false);
    }
  }else{
    appendMsg(userMsg, 'user', false, false);
  }

  // AI繪圖指令（如果用戶問"畫圖"或"生成圖片"相關字眼）
  if(/^ *(畫|生成|create|draw|generate|make).*(圖|image|picture|photo|畫|圖片)/i.test(msg)) {
    await genImage(msg.replace(/^ *(畫|生成|create|draw|generate|make)/i, ""));
    uploadedFile = null;
    uploadedContent = null;
    uploadedImageBase64 = null;
    uploadedImageMime = null;
    fileInput.value = '';
    filenameLabel.textContent = '';
    filenameLabel.style.display = 'none';
    filePreview.style.display = 'none';
    filePreview.src = '';
    conversationHistory.push({role: "user", parts: [{ text: msg }]});
    updateChatTitle(chats.find(c=>c.id===currentChatId));
    saveChatsToStorage();
    renderChatList();
    return;
  }

  let userParts = [];
  if(msg) userParts.push({ text: msg });
  if(hasImage){
    userParts.push({
      inline_data: {
        mime_type: uploadedImageMime,
        data: uploadedImageBase64
      }
    });
  } else if(uploadedContent){
    userParts.push({ text: `\n[Uploaded file: ${uploadedFile.name}]\n${uploadedContent}` });
  }
  conversationHistory.push({ role: "user", parts: userParts });

  sendBtn.disabled = true;
  const aiBubble = appendMsg('', 'ai', true, false);

  let contextToSend = [];
  if (conversationHistory.length > MAX_CONTEXT_MESSAGES) {
    contextToSend = conversationHistory.slice(-MAX_CONTEXT_MESSAGES);
  } else {
    contextToSend = [...conversationHistory];
  }

  try {
    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + apiKey, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: contextToSend })
    });
    const data = await response.json();
    chatArea.removeChild(aiBubble.parentNode);
    const newBubble = appendMsg('', 'ai', false, true);
    if (data.candidates && data.candidates[0]) {
      const aiMsg = data.candidates[0].content.parts[0].text;
      fadeInAIMessage(newBubble, aiMsg);
      conversationHistory.push({
        role: "model",
        parts: data.candidates[0].content.parts
      });
    } else {
      fadeInAIMessage(newBubble, 'Sorry, AI returned no answer.');
      conversationHistory.push({
        role: "model",
        parts: [{ text: "Sorry, AI returned no answer." }]
      });
    }
  } catch (err) {
    chatArea.removeChild(aiBubble.parentNode);
    const newBubble = appendMsg('', 'ai', false, true);
    fadeInAIMessage(newBubble, 'Network error. Please try again.');
    conversationHistory.push({
      role: "model",
      parts: [{ text: "Network error. Please try again." }]
    });
  }
  sendBtn.disabled = false;
  uploadedFile = null;
  uploadedContent = null;
  uploadedImageBase64 = null;
  uploadedImageMime = null;
  fileInput.value = '';
  filenameLabel.textContent = '';
  filenameLabel.style.display = 'none';
  filePreview.style.display = 'none';
  filePreview.src = '';
  updateChatTitle(chats.find(c=>c.id===currentChatId));
  saveChatsToStorage();
  renderChatList();
});

showSuggestionsBar(true);
</script>
</body>
</html>
